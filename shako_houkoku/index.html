<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自動車保管場所現地調査結果報告書 作成アプリ</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; font-size: 22px; margin-bottom: 20px; }
        h2 { font-size: 16px; border-bottom: 2px solid #007BFF; padding-bottom: 5px; margin-top: 30px; margin-bottom: 15px; color: #007BFF; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        input[type="text"], input[type="number"], input[type="date"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        button { display: block; width: 100%; padding: 15px; background-color: #007BFF; color: white; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; margin-top: 30px; }
        button:hover { background-color: #0056b3; }
        .row { display: flex; gap: 10px; align-items: center; }
        .col { flex: 1; }
        .suffix { white-space: nowrap; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>自動車保管場所現地調査結果報告書<br>作成アプリ</h1>
    <form id="pdfForm">
        
        <h2>基本情報</h2>
        <div class="form-group">
            <label>提出日付</label>
            <div class="row">
                <input type="number" id="date_year" placeholder="令和〇" style="flex:1">
                <span class="suffix">年</span>
                <input type="number" id="date_month" placeholder="月" style="flex:1">
                <span class="suffix">月</span>
                <input type="number" id="date_day" placeholder="日" style="flex:1">
                <span class="suffix">日</span>
            </div>
        </div>

        <div class="form-group">
            <label>提出先 警察署</label>
            <div class="row">
                <input type="text" id="police_station" placeholder="例：丸の内">
                <span class="suffix">警察署長 殿</span>
            </div>
        </div>

        <h2>申請者情報</h2>
        <div class="form-group">
            <label>申請者の住所</label>
            <input type="text" id="applicant_address" placeholder="東京都千代田区...">
        </div>
        <div class="form-group">
            <label>申請者の氏名</label>
            <input type="text" id="applicant_name" placeholder="山田 太郎">
        </div>

        <h2>保管場所（車庫）の情報</h2>
        <div class="form-group">
            <label>保管場所の位置（住所）</label>
            <input type="text" id="storage_location" placeholder="同上 または 住所を入力">
        </div>

        <div class="form-group">
            <label>前面道路の幅員</label>
            <div class="row">
                <input type="text" id="road_width" placeholder="例：6.0">
                <span class="suffix">メートル</span>
            </div>
        </div>

        <div class="form-group">
            <label>保管場所の広さ</label>
            <div class="row">
                <div class="col">
                    <label style="font-size:12px;">縦 (m)</label>
                    <input type="text" id="dim_length" placeholder="5.0">
                </div>
                <div class="col">
                    <label style="font-size:12px;">横 (m)</label>
                    <input type="text" id="dim_width" placeholder="2.5">
                </div>
                <div class="col">
                    <label style="font-size:12px;">面積 (㎡)</label>
                    <input type="text" id="dim_area" placeholder="12.5">
                </div>
            </div>
        </div>

        <!-- 履歴機能付き調査員名 -->
        <h2>調査員情報</h2>
        <div class="form-group">
            <label>調査員 氏名</label>
            <input type="text" id="surveyor_name" list="surveyor_name_list" autocomplete="off" placeholder="履歴から選択可">
            <datalist id="surveyor_name_list"></datalist>
        </div>

        <button type="button" onclick="generatePDF()">PDFを作成してダウンロード</button>
    </form>
</div>

<script>
    const { PDFDocument, rgb } = PDFLib;

    // --- 履歴保存機能 ---
    const STORAGE_KEY_SURVEYOR = 'surveyor_name_history';

    window.onload = function() {
        // 今日の日付を初期セット
        const now = new Date();
        // 令和計算 (2025年=令和7年) ※簡易計算
        document.getElementById('date_year').value = now.getFullYear() - 2018; 
        document.getElementById('date_month').value = now.getMonth() + 1;
        document.getElementById('date_day').value = now.getDate();

        loadHistory(STORAGE_KEY_SURVEYOR, 'surveyor_name_list');
    };

    function loadHistory(key, datalistId) {
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        const datalist = document.getElementById(datalistId);
        datalist.innerHTML = '';
        history.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            datalist.appendChild(option);
        });
    }

    function saveHistory(key, value) {
        if (!value) return;
        let history = JSON.parse(localStorage.getItem(key) || '[]');
        history = history.filter(item => item !== value);
        history.unshift(value);
        if (history.length > 20) history.pop();
        localStorage.setItem(key, JSON.stringify(history));
    }
    // ------------------

    async function generatePDF() {
        let pdfBytes, fontBytes;
        
        try {
            // 背景画像のPDFファイル名 (template.pdf に変更して配置してください)
            const pdfUrl = 'template.pdf';
            const fontUrl = 'font.ttf';
            
            [pdfBytes, fontBytes] = await Promise.all([
                fetch(pdfUrl).then(res => res.arrayBuffer()),
                fetch(fontUrl).then(res => res.arrayBuffer())
            ]);
        } catch (e) {
            alert("ファイルの読み込みに失敗しました。template.pdf と font.ttf が同じフォルダにあるか確認してください。");
            return;
        }

        const pdfDoc = await PDFDocument.load(pdfBytes);
        pdfDoc.registerFontkit(fontkit);
        const customFont = await pdfDoc.embedFont(fontBytes);
        const page = pdfDoc.getPages()[0];
        const { width, height } = page.getSize(); // ページサイズ取得(A4なら w:595, h:842付近)

        // テキスト描画用ヘルパー関数
        const drawText = (text, x, y, size = 11) => {
            if (!text) return;
            page.drawText(String(text), {
                x: x,
                y: y,
                size: size,
                font: customFont,
                color: rgb(0, 0, 0),
            });
        };

        const v = (id) => document.getElementById(id).value;

        // === 座標のマッピング ===
        // ※PDFの座標系は左下が(0,0)です。Y軸は上に行くほど大きくなります。
        // お手持ちのPDFに合わせて微調整が必要な場合は、ここの数値を変更してください。

        // 1. 日付 (上部)
        // おおよそ上から1/8くらいの位置と推測
        const dateY = height - 125; 
        drawText(v('date_year'), 80, dateY);  // 令和〇年
        drawText(v('date_month'), 140, dateY); // 〇月
        drawText(v('date_day'), 190, dateY);  // 〇日

        // 2. 警察署長殿
        drawText(v('police_station'), 160, height - 150, 14);

        // 3. 調査日・調査員 (少し下)
        const surveyY = height - 180;
        drawText(v('date_year'), 175, surveyY);
        drawText(v('date_month'), 215, surveyY);
        drawText(v('date_day'), 250, surveyY);
        drawText(v('surveyor_name'), 330, surveyY);

        // 4. 申請者の住所及び氏名
        // 大きな枠内への配置。住所を上段、氏名を下段にします。
        const applicantBaseY = height - 265;
        drawText(v('applicant_address'), 150, applicantBaseY + 10, 10);
        drawText(v('applicant_name'), 150, applicantBaseY - 10, 12);

        // 5. 保管場所の位置
        drawText(v('storage_location'), 150, height - 305, 10);

        // 6. 前面道路 幅 (中段あたり)
        // 「前面道路 幅」の右横
        drawText(v('road_width'), 230, height - 445, 11);

        // 7. 保管場所の広さ (下段)
        const dimsY = height - 575;
        // 縦
        drawText(v('dim_length'), 190, dimsY);
        // 横
        drawText(v('dim_width'), 350, dimsY);
        // 面積
        drawText(v('dim_area'), 500, dimsY);

        // --- 履歴保存実行 ---
        saveHistory(STORAGE_KEY_SURVEYOR, v('surveyor_name'));
        loadHistory(STORAGE_KEY_SURVEYOR, 'surveyor_name_list');

        // ファイル名の生成
        const y = v('date_year') || '0';
        const m = (v('date_month') || '0').padStart(2, '0');
        const d = (v('date_day') || '0').padStart(2, '0');
        let applicant = v('applicant_name') || '名称未設定';
        applicant = applicant.replace(/[\\/:*?"<>|]/g, ''); // ファイル名に使えない文字を除去

        const fileName = `R${y}${m}${d}_現地調査報告書_${applicant}.pdf`;

        // ダウンロード実行
        const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
        const link = document.createElement('a');
        link.href = pdfDataUri;
        link.download = fileName;
        link.click();
    }
</script>

</body>
</html>