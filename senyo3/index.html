<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>継続検査用データ入力アプリ（軽専用2号様式）</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        h1 { text-align: center; font-size: 22px; margin-bottom: 30px; font-weight: bold; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 16px; }
        
        input[type="text"] { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
            font-size: 16px; 
            color: #333;
        }
        input::placeholder { color: #aaa; }

        /* レイアウト用 */
        .row { display: flex; gap: 15px; margin-bottom: 10px; }
        .col { flex: 1; }
        
        /* 区分け線 */
        .section-divider { margin: 25px 0; border-top: 1px solid #bbb; }

        /* 特殊な入力欄用 */
        .hyphen { align-self: center; font-size: 20px; padding: 0 5px; }
        
        button { 
            display: block; 
            width: 100%; 
            padding: 15px; 
            background-color: #007BFF; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 18px; 
            cursor: pointer; 
            margin-top: 30px; 
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <h1>継続検査用データ入力アプリ（軽専用2号様式）</h1>
    <form id="pdfForm">
        
        <!-- 1段目 -->
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>車両提示</label>
                    <input type="text" id="v_presentation" maxlength="1" placeholder="1文字">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>手数料</label>
                    <input type="text" id="fee" maxlength="1" placeholder="1文字">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>証明書指示</label>
                    <input type="text" id="cert_instruction" maxlength="1" placeholder="1文字">
                </div>
            </div>
        </div>

        <!-- 2段目 -->
        <div class="row">
            <div class="col">
                <div class="form-group">
                    <label>処理 (左欄)</label>
                    <input type="text" id="process_left" maxlength="1" placeholder="1文字">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>処理 (右欄)</label>
                    <input type="text" id="process_right" maxlength="1" placeholder="1文字">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>例外</label>
                    <input type="text" id="exception" maxlength="1" placeholder="1文字">
                </div>
            </div>
            <div class="col">
                <div class="form-group">
                    <label>制限解除</label>
                    <input type="text" id="restriction" maxlength="1" placeholder="1文字">
                </div>
            </div>
        </div>

        <!-- 車両番号 -->
        <div class="form-group">
            <label>車両番号</label>
            <div class="row">
                <input type="text" id="car_num_1" placeholder="地域名" style="flex: 3;">
                <input type="text" id="car_num_2" placeholder="123" style="flex: 1.5;">
                <input type="text" id="car_num_3" placeholder="あ" style="flex: 1;">
                <input type="text" id="car_num_4" placeholder="1234" style="flex: 3;">
                <input type="text" id="car_num_5" placeholder="小板" style="flex: 1;">
            </div>
        </div>

        <!-- 車台番号 -->
        <div class="form-group">
            <label>車台番号（下7桁）</label>
            <input type="text" id="chassis_num" maxlength="20" placeholder="最大７文字（例：ＡＢ３１２３４）">
        </div>

        <!-- 整備工場コード -->
        <div class="form-group">
            <label>整備工場コード</label>
            <div class="row" style="gap:10px;">
                <input type="text" id="factory_code_1" maxlength="2" placeholder="2桁" style="flex:1;">
                <span class="hyphen">-</span>
                <input type="text" id="factory_code_2" maxlength="5" placeholder="5桁" style="flex:2.5;">
            </div>
        </div>

        <div class="section-divider"></div>

        <!-- 申請者情報 -->
        <div class="form-group">
            <label>申請者（使用者）氏名又は名称</label>
            <input type="text" id="applicant_name" placeholder="山田 太郎">
        </div>
        
        <div class="form-group">
            <label>申請者 住所</label>
            <input type="text" id="applicant_address" placeholder="東京都...">
        </div>

        <button type="button" onclick="generatePDF()">PDFを作成してダウンロード</button>
    </form>
</div>

<script>
    const { PDFDocument, rgb } = PDFLib;

    async function generatePDF() {
        let pdfBytes, fontBytes;
        
        try {
            const pdfUrl = 'template.pdf'; 
            const fontUrl = 'font.ttf'; 
            
            [pdfBytes, fontBytes] = await Promise.all([
                fetch(pdfUrl).then(res => res.arrayBuffer()),
                fetch(fontUrl).then(res => res.arrayBuffer())
            ]);
        } catch (e) {
            alert("template.pdf と font.ttf が必要です。");
            return;
        }

        const pdfDoc = await PDFDocument.load(pdfBytes);
        pdfDoc.registerFontkit(fontkit);
        const customFont = await pdfDoc.embedFont(fontBytes);
        const page = pdfDoc.getPages()[0];
        
        const v = (id) => document.getElementById(id).value;

        // 横書き描画
        const drawText = (text, x, y, size = 11, spacing = 0) => {
            if (!text) return;
            if (spacing > 0) {
                for (let i = 0; i < text.length; i++) {
                    page.drawText(text[i], { x: x + (i * spacing), y, size, font: customFont, color: rgb(0, 0, 0) });
                }
            } else {
                page.drawText(text, { x, y, size, font: customFont, color: rgb(0, 0, 0) });
            }
        };

        // 縦書き描画
        const drawVerticalText = (text, x, y, size = 10) => {
            if (!text) return;
            const lineHeight = size * 1.2; 
            for (let i = 0; i < text.length; i++) {
                page.drawText(text[i], { x, y: y - (i * lineHeight), size, font: customFont, color: rgb(0, 0, 0) });
            }
        };

        // --- PDF座標へのマッピング (適宜 template.pdf に合わせて調整してください) ---
        // 以下は「専用3号様式」の流用サンプルですので、座標の調整が必要です。
        drawText(v('v_presentation'), 50, 750, 12);
        drawText(v('fee'), 150, 750, 12);
        drawText(v('cert_instruction'), 250, 750, 12);
        
        drawText(v('car_num_1'), 50, 680, 12);
        drawText(v('car_num_2'), 120, 680, 12);
        // ... 他の項目も同様に

        // 申請者 縦書き（例）
        drawVerticalText(v('applicant_name'), 50, 400, 11);
        drawVerticalText(v('applicant_address'), 80, 400, 11);

        const fileName = `継続検査_軽2号_${v('applicant_name') || '未入力'}.pdf`;
        const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
        const link = document.createElement('a');
        link.href = pdfDataUri;
        link.download = fileName;
        link.click();
    }
</script>
</body>
</html>