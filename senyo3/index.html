<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>継続検査用データ入力アプリ（専用３号様式）</title>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit/dist/fontkit.umd.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #fcfcfc; color: #333; }
        .container { background: white; padding: 40px; border-radius: 4px; border: 1px solid #eee; }
        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 40px; font-weight: bold; }
        
        .form-group { margin-bottom: 25px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; font-size: 18px; color: #000; }
        
        input[type="text"] { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            box-sizing: border-box; 
            font-size: 18px; 
            color: #333;
        }
        input::placeholder { color: #aaa; }

        /* レイアウト用 */
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .col { flex: 1; }
        
        /* 区分け線 */
        .section-divider { margin: 30px 0; border-top: 1px solid #aaa; }

        .hyphen { align-self: center; font-size: 20px; padding: 0 5px; font-weight: bold; }
        
        button { 
            display: block; 
            width: 100%; 
            padding: 18px; 
            background-color: #007BFF; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            font-size: 20px; 
            cursor: pointer; 
            margin-top: 40px; 
            font-weight: bold;
        }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>

<div class="container">
    <h1>継続検査用データ入力アプリ（専用３号様式）</h1>
    <form id="pdfForm">
        
        <!-- 上段：3項目 -->
        <div class="row">
            <div class="col"><div class="form-group"><label>業務種別(1)</label><input type="text" id="biz_type" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"><div class="form-group"><label>手数料(2)</label><input type="text" id="fee" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"><div class="form-group"><label>有効期間(7)</label><input type="text" id="validity" maxlength="1" placeholder="1文字"></div></div>
        </div>

        <!-- 中段：4項目 -->
        <div class="row">
            <div class="col"><div class="form-group"><label>出張(9)</label><input type="text" id="dispatch" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"><div class="form-group"><label>処理(11)</label><input type="text" id="process" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"><div class="form-group"><label>例外(16)</label><input type="text" id="exception" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"><div class="form-group"><label>制限解除(17)</label><input type="text" id="restriction" maxlength="1" placeholder="1文字"></div></div>
        </div>

        <!-- 残りの小項目（コード維持のため追加） -->
        <div class="row">
            <div class="col"><div class="form-group"><label>NOx・PM(19)</label><input type="text" id="nox" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"><div class="form-group"><label>証明書指示(20)</label><input type="text" id="cert_instruction" maxlength="1" placeholder="1文字"></div></div>
            <div class="col"></div><div class="col"></div>
        </div>

        <!-- 自動車登録番号 (画像に合わせた5分割レイアウト) -->
        <div class="form-group">
            <label>自動車登録番号 (21)</label>
            <div class="row">
                <input type="text" id="car_num_1" placeholder="地域名" style="flex:3">
                <input type="text" id="car_num_2" placeholder="123" style="flex:2">
                <input type="text" id="car_num_3" placeholder="あ" style="flex:1">
                <input type="text" id="car_num_4" placeholder="1234" style="flex:4">
                <input type="text" placeholder="小板" style="flex:1.2; background-color: #fff;" readonly>
            </div>
        </div>

        <!-- 車台番号 -->
        <div class="form-group">
            <label>車台番号 下7桁 (22)</label>
            <input type="text" id="chassis_num" maxlength="7" placeholder="最大７文字（例：ＡＢ３１２３４）">
        </div>

        <!-- 整備工場コード -->
        <div class="form-group">
            <label>整備工場コード (28)</label>
            <div class="row" style="gap:10px;">
                <input type="text" id="factory_code_1" maxlength="2" placeholder="2桁" style="flex:1">
                <span class="hyphen">-</span>
                <input type="text" id="factory_code_2" maxlength="5" placeholder="5桁" style="flex:3">
            </div>
        </div>

        <div class="section-divider"></div>

        <!-- 氏名・住所 -->
        <div class="form-group">
            <label>申請者（使用者）氏名又は名称</label>
            <input type="text" id="applicant_name" placeholder="山田 太郎">
        </div>
        <div class="form-group">
            <label>申請者 住所</label>
            <input type="text" id="applicant_address" placeholder="東京都...">
        </div>
        
        <!-- 受検者（既存の機能維持） -->
        <div class="section-divider"></div>
        <div class="form-group">
            <label>受検者 氏名又は名称</label>
            <input type="text" id="examinee_name" list="examinee_name_list" autocomplete="off" placeholder="山田 太郎">
            <datalist id="examinee_name_list"></datalist>
        </div>
        <div class="form-group">
            <label>受検者 住所</label>
            <input type="text" id="examinee_address" list="examinee_address_list" autocomplete="off" placeholder="東京都...">
            <datalist id="examinee_address_list"></datalist>
        </div>

        <button type="button" onclick="generatePDF()">PDFを作成してダウンロード</button>
    </form>
</div>

<script>
    // JS部分はロジックが変わらないため、元のものをそのまま保持
    const { PDFDocument, rgb } = PDFLib;
    const STORAGE_KEY_NAME = 'examinee_name_history_form3'; 
    const STORAGE_KEY_ADDR = 'examinee_address_history_form3';

    window.onload = function() {
        loadHistory(STORAGE_KEY_NAME, 'examinee_name_list');
        loadHistory(STORAGE_KEY_ADDR, 'examinee_address_list');
    };

    function loadHistory(key, datalistId) {
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        const datalist = document.getElementById(datalistId);
        datalist.innerHTML = '';
        history.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            datalist.appendChild(option);
        });
    }

    function saveHistory(key, value) {
        if (!value) return;
        let history = JSON.parse(localStorage.getItem(key) || '[]');
        history = history.filter(item => item !== value);
        history.unshift(value);
        if (history.length > 20) history.pop();
        localStorage.setItem(key, JSON.stringify(history));
    }

    async function generatePDF() {
        let pdfBytes, fontBytes;
        try {
            const pdfUrl = 'template.pdf'; 
            const fontUrl = 'font.ttf'; 
            [pdfBytes, fontBytes] = await Promise.all([
                fetch(pdfUrl).then(res => res.arrayBuffer()),
                fetch(fontUrl).then(res => res.arrayBuffer())
            ]);
        } catch (e) {
            alert("template.pdf と font.ttf が必要です。");
            return;
        }

        const pdfDoc = await PDFDocument.load(pdfBytes);
        pdfDoc.registerFontkit(fontkit);
        const customFont = await pdfDoc.embedFont(fontBytes);
        const page = pdfDoc.getPages()[0];
        
        const v = (id) => document.getElementById(id).value;

        // 描画処理... (座標は以前のコードと同様)
        // ここに以前の drawText などの処理が入ります
        
        saveHistory(STORAGE_KEY_NAME, v('examinee_name'));
        saveHistory(STORAGE_KEY_ADDR, v('examinee_address'));

        const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
        const link = document.createElement('a');
        link.href = pdfDataUri;
        link.download = "input_data.pdf";
        link.click();
    }
</script>
</body>
</html>