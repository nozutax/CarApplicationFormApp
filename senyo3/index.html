<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>継続検査用データ入力アプリ（専用３号様式）</title>
    <!-- ライブラリの読み込み順を変更・整理 -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; font-size: 24px; margin-bottom: 30px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input[type="text"], input[type="number"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        .box-input { letter-spacing: 5px; }
        button { display: block; width: 100%; padding: 15px; background-color: #007BFF; color: white; border: none; border-radius: 4px; font-size: 18px; cursor: pointer; margin-top: 30px; }
        button:hover { background-color: #0056b3; }
        .row { display: flex; gap: 10px; align-items: flex-end; }
        .col { flex: 1; }
        .hyphen { font-weight: bold; padding: 0 5px; align-self: center; }
        .section-divider { margin: 20px 0; border-top: 1px dashed #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h1>継続検査用データ入力アプリ（専用３号様式）</h1>
    <form id="pdfForm">
        <!-- 上段エリア -->
        <div class="row">
            <div class="col"><div class="form-group"><label>業務種別(1)</label><input type="text" id="biz_type" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>手数料(2)</label><input type="text" id="fee" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>有効期間(7)</label><input type="text" id="validity" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>出張(9)</label><input type="text" id="dispatch" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>処理(11)</label><input type="text" id="process" maxlength="1"></div></div>
        </div>
        <div class="row">
            <div class="col"><div class="form-group"><label>例外(16)</label><input type="text" id="exception" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>制限解除(17)</label><input type="text" id="restriction" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>NOx・PM(19)</label><input type="text" id="nox" maxlength="1"></div></div>
            <div class="col"><div class="form-group"><label>証明書指示(20)</label><input type="text" id="cert_instruction" maxlength="1"></div></div>
            <div class="col"></div> 
        </div>

        <div class="section-divider"></div>

        <!-- 中段：車両情報 -->
        <div class="form-group">
            <label>自動車登録番号 (21)</label>
            <div class="row">
                <input type="text" id="car_num_1" placeholder="地域" style="flex:2">
                <input type="text" id="car_num_2" placeholder="分類" style="flex:1.5">
                <input type="text" id="car_num_3" placeholder="かな" style="flex:0.8">
                <input type="text" id="car_num_4" placeholder="一連番号" style="flex:2">
            </div>
        </div>
        <div class="row">
            <div class="col" style="flex: 1.5;"><div class="form-group"><label>車台番号 下7桁 (22)</label><input type="text" id="chassis_num" maxlength="7" class="box-input"></div></div>
            <div class="col" style="flex: 2;">
                <div class="form-group">
                    <label>整備工場コード (28)</label>
                    <div class="row" style="gap:5px;">
                        <input type="text" id="factory_code_1" maxlength="2" style="flex:1">
                        <span class="hyphen">-</span>
                        <input type="text" id="factory_code_2" maxlength="5" style="flex:2">
                    </div>
                </div>
            </div>
        </div>

        <div class="section-divider"></div>

        <!-- 下段：氏名・住所 -->
        <div class="form-group"><label>申請者（使用者）氏名</label><input type="text" id="applicant_name"></div>
        <div class="form-group"><label>申請者 住所</label><input type="text" id="applicant_address"></div>
        <div class="form-group"><label>受検者 氏名</label><input type="text" id="examinee_name" list="examinee_name_list"><datalist id="examinee_name_list"></datalist></div>
        <div class="form-group"><label>受検者 住所</label><input type="text" id="examinee_address" list="examinee_address_list"><datalist id="examinee_address_list"></datalist></div>

        <button type="button" onclick="generatePDF()">PDFを作成してダウンロード</button>
    </form>
</div>

<script>
    // pdf-libの読み込み確認と初期化
    const { PDFDocument, rgb, degrees } = PDFLib;

    const STORAGE_KEY_NAME = 'examinee_name_history_form3'; 
    const STORAGE_KEY_ADDR = 'examinee_address_history_form3';

    window.onload = function() {
        loadHistory(STORAGE_KEY_NAME, 'examinee_name_list');
        loadHistory(STORAGE_KEY_ADDR, 'examinee_address_list');
    };

    function loadHistory(key, datalistId) {
        const history = JSON.parse(localStorage.getItem(key) || '[]');
        const datalist = document.getElementById(datalistId);
        if(!datalist) return;
        datalist.innerHTML = '';
        history.forEach(item => {
            const option = document.createElement('option');
            option.value = item;
            datalist.appendChild(option);
        });
    }

    function saveHistory(key, value) {
        if (!value) return;
        let history = JSON.parse(localStorage.getItem(key) || '[]');
        history = history.filter(item => item !== value);
        history.unshift(value);
        if (history.length > 20) history.pop();
        localStorage.setItem(key, JSON.stringify(history));
    }

    async function generatePDF() {
        let pdfBytes, fontBytes;
        
        try {
            // template.pdf と font.ttf が同一ディレクトリに必要
            [pdfBytes, fontBytes] = await Promise.all([
                fetch('template.pdf').then(res => {
                    if (!res.ok) throw new Error('template.pdfが見つかりません');
                    return res.arrayBuffer();
                }),
                fetch('font.ttf').then(res => {
                    if (!res.ok) throw new Error('font.ttfが見つかりません');
                    return res.arrayBuffer();
                })
            ]);
        } catch (e) {
            alert(e.message + "\nファイルが同じフォルダにあるか確認してください。");
            return;
        }

        try {
            const pdfDoc = await PDFDocument.load(pdfBytes);
            
            // fontkitの登録（UMD形式に対応した記述）
            pdfDoc.registerFontkit(window.fontkit);
            
            const customFont = await pdfDoc.embedFont(fontBytes);
            const page = pdfDoc.getPages()[0];
            
            // --- 回転補正付き描画関数 ---
            const drawText = (text, x, y, size = 10, spacing = 0, angle = 0) => {
                if (!text) return;
                const correctionAngle = 90; // 90度回転して出力されるのを補正
                const finalRotation = degrees(angle + correctionAngle);

                if (spacing > 0) {
                    for (let i = 0; i < text.length; i++) {
                        page.drawText(text[i], {
                            x: x + (i * spacing),
                            y: y,
                            size: size,
                            font: customFont,
                            color: rgb(0, 0, 0),
                            rotate: finalRotation,
                        });
                    }
                } else {
                    page.drawText(text, { 
                        x: x, 
                        y: y, 
                        size: size, 
                        font: customFont, 
                        color: rgb(0, 0, 0),
                        rotate: finalRotation, 
                    });
                }
            };

            const v = (id) => document.getElementById(id).value;

            // 1. 上部
            const ROW_1_Y = 760; 
            const BOX_SIZE = 12; 
            drawText(v('biz_type'), 45, ROW_1_Y, BOX_SIZE);         
            drawText(v('fee'), 125, ROW_1_Y, BOX_SIZE);             
            drawText(v('validity'), 190, ROW_1_Y, BOX_SIZE);        
            drawText(v('dispatch'), 270, ROW_1_Y, BOX_SIZE);        
            drawText(v('process'), 345, ROW_1_Y, BOX_SIZE);         
            drawText(v('exception'), 485, ROW_1_Y, BOX_SIZE);       
            drawText(v('restriction'), 545, ROW_1_Y, BOX_SIZE);     
            drawText(v('nox'), 635, ROW_1_Y, BOX_SIZE);             
            drawText(v('cert_instruction'), 720, ROW_1_Y, BOX_SIZE);

            // 2. 自動車登録番号・車台番号等
            const ROW_2_Y = 660; 
            const BOX_WIDTH = 17; 
            drawText(v('car_num_1'), 40, ROW_2_Y, 12, 28); 
            drawText(v('car_num_2'), 150, ROW_2_Y, 12, BOX_WIDTH);
            drawText(v('car_num_3'), 220, ROW_2_Y, 12);
            drawText(v('car_num_4'), 260, ROW_2_Y, 12, BOX_WIDTH);
            drawText(v('chassis_num'), 360, ROW_2_Y, 12, BOX_WIDTH);
            drawText(v('factory_code_1'), 660, ROW_2_Y, 12, BOX_WIDTH);
            drawText(v('factory_code_2'), 705, ROW_2_Y, 12, BOX_WIDTH);

            // 3. 氏名・住所
            const NAME_SIZE = 10;
            const NAME_LEFT_X = 50; 
            drawText(v('applicant_name'), NAME_LEFT_X, 420, NAME_SIZE);
            drawText(v('applicant_address'), NAME_LEFT_X, 390, NAME_SIZE);
            drawText(v('examinee_name'), NAME_LEFT_X, 320, NAME_SIZE);
            drawText(v('examinee_address'), NAME_LEFT_X, 290, NAME_SIZE);

            // 保存
            saveHistory(STORAGE_KEY_NAME, v('examinee_name'));
            saveHistory(STORAGE_KEY_ADDR, v('examinee_address'));
            loadHistory(STORAGE_KEY_NAME, 'examinee_name_list');
            loadHistory(STORAGE_KEY_ADDR, 'examinee_address_list');

            // ダウンロード実行
            const pdfBytesSaved = await pdfDoc.save();
            const blob = new Blob([pdfBytesSaved], { type: 'application/pdf' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            let applicant = v('applicant_name') || '未入力';
            link.download = `${dateStr}_継続検査申請書_${applicant}.pdf`;
            link.click();

        } catch (error) {
            console.error(error);
            alert("PDF作成中にエラーが発生しました: " + error.message);
        }
    }
</script>

</body>
</html>
